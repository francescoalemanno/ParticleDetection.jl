using ParticleDetection
using Test
using Serialization

@testset "Detect Particles" begin
    ima=deserialize(joinpath(@__DIR__, "particles.bin"))
    @time lm=local_maxima(bp_filter(ima,5,20),0.1)
    P=[Tuple(p) for p in CartesianIndices(lm) if lm[p]>0.5]
    @test P==Tuple{Int64,Int64}[(1081, 32), (1112, 94), (1145, 120), (1102, 150),
                                (818, 309), (2205, 322), (785, 412), (1224, 440),
                                (839, 446), (864, 449), (774, 465), (829, 487),
                                (774, 504), (871, 510), (801, 523), (812, 541),
                                (834, 541), (806, 549), (863, 555), (849, 563),
                                (896, 571), (916, 574), (850, 576), (863, 609),
                                (997, 675), (975, 682), (986, 684), (923, 687),
                                (928, 695), (996, 711), (1405, 715), (1417, 722),
                                (1161, 739), (1284, 765), (1288, 777), (909, 783),
                                (931, 803), (917, 805), (894, 809), (944, 847),
                                (963, 854), (344, 867), (345, 873), (918, 874),
                                (930, 951), (702, 971), (875, 1032), (1524, 1099),
                                (1766, 1228), (1777, 1237), (1827, 1278), (944, 1281),
                                (933, 1291), (961, 1294), (1075, 1307), (1285, 1318),
                                (1688, 1329), (1285, 1334), (1748, 1334), (1219, 1341),
                                (1284, 1346), (2020, 1351), (108, 1423), (52, 1465),
                                (1820, 1505), (1830, 1514), (1276, 1552), (623, 1578),
                                (1194, 1580), (1177, 1583), (1236, 1609), (1183, 1610),
                                (1263, 1650), (2194, 1655), (2296, 1655), (1939, 1657),
                                (1923, 1675), (1312, 1685), (1915, 1686), (2287, 1690),
                                (1966, 1710), (2224, 1710), (1147, 1715), (2253, 1718),
                                (1113, 1719), (1327, 1722), (1396, 1738), (1773, 1750),
                                (2154, 1762), (1201, 1770), (2054, 1775), (1892, 1779),
                                (1957, 1782), (2023, 1783), (1125, 1795), (1114, 1802),
                                (2086, 1807), (1090, 1834), (1573, 1846), (1759, 1848),
                                (2086, 1850), (1127, 1851), (1457, 1859), (1167, 1864),
                                (1607, 1876), (1511, 1885), (887, 1892), (557, 1914),
                                (1214, 1918), (2066, 1939), (1848, 1944), (1830, 1949),
                                (1913, 1953), (1901, 1955), (1852, 1956), (1865, 1957),
                                (905, 1958), (2269, 1958), (1809, 1961), (998, 1965),
                                (1005, 2000), (1373, 2017), (1029, 2043), (2225, 2059),
                                (887, 2075), (1631, 2145), (1249, 2147), (879, 2153),
                                (1734, 2153), (836, 2169), (892, 2173), (94, 2303),
                                (162, 2327), (431, 2348), (161, 2363), (45, 2364), (268, 2364)]
end
